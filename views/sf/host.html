{% extends "sf/base.html" %}

{% block title %}Host - {{ super() }}{% endblock %}

{% block head %}
    {{ super() }}

    {% include "sf/templates.html" %}

    <style>
        /* Override the default dialog position so that it is not in front of the file/info view. */
        .modal, .modal.fade.in {
            top: 20%;
            left: 30%;
        }
    </style>

    <script type="text/javascript">
        StrikeFinder.host = {{ host }};
        StrikeFinder.tags = {{ tags }};

        $(document).ready(function () {
            (function () {

                // The app to display the views on this page.
                var HostsApp = StrikeFinder.View.extend({
                    initialize: function(options) {
                        var view = this;

                        view.model = new StrikeFinder.AgentHostModel(StrikeFinder.host);

                        // The hosts view.
                        view.hosts_view = new StrikeFinder.HostView({
                            el: '#host-div',
                            model: view.model
                        });
                        view.hosts_view.render();

                        // The hits view.
                        view.hits_table_view = new StrikeFinder.HostHitsTableView({
                            el: '#hits-table'
                        });
                        view.listenTo(view.hits_table_view, 'load', function () {
                            // Load the first hit on load of the view.
                            view.hits_table_view.select_row(0);
                        });

                        // The hits details.
                        view.hits_details_view = new StrikeFinder.HitsDetailsView({
                            el: '#hits-details',
                            hits_table_view: view.hits_table_view,
                            suppress: false,    // Don't support suppression creation.
                            masstag: false      // Don't support mass tagging.
                        });
                        view.listenTo(view.hits_details_view, 'create:tag', function(row, tagname) {
                            view.hits_table_view.update_row('uuid', row.uuid, 'tagname', tagname, 0);
                            view.hits_details_view.fetch();
                        });

                        view.fetch(view.model.get('hash'));
                    },
                    fetch: function(am_cert_hash) {
                        var view = this;
                        view.hits_table_view.fetch(am_cert_hash);
                    }
                });

                // Create an app instance.
                var hosts_app = new HostsApp({
                    el: $(document.body)
                });

                var HostsRouter = Backbone.Router.extend({
                    routes: {
                        "hash/:hash/": "view_by_hash",
                        "hash/:hash": "view_by_hash"
                    },
                    view_by_hash: function (hash) {
                        // Retrieve the hosts data.
                        hosts_app.fetch(hash);
                    }
                });
                var hosts_router = new HostsRouter();
                Backbone.history.start();
            })();
        });
    </script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row-fluid">
        <div class="span12">
            <div id="host-div"></div>
        </div>
    </div>

    <div class="row-fluid">
        <div class="span12">
            <div class="hits-div">
                <table id="hits-table" class="table table-striped table-bordered table-hover">
                </table>
            </div>
        </div>
    </div>

    {% set hide_hits = true %}
    {% set hide_suppressions = true %}
    {% include "sf/hits_template.html" %}
</div>

<br/>
{% endblock %}