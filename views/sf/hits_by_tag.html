{% extends "sf/base.html" %}

{% block title %}View by Tag - {{ super() }}{% endblock %}

{% block head %}
{{ super() }}

<style>
    /* Override the default dialog position so that it is not in front of the file/info view. */
    .modal, .modal.fade.in {
        top: 20%;
        left: 30%;
    }
</style>

<script type="text/javascript">
    StrikeFinder.tags = {{ tags }};
    StrikeFinder.searchable_tags = {{ searchable_tags }};

    StrikeFinder.HitsByTagTableView = StrikeFinder.TableView.extend({
        initialize: function () {
            var view = this;

            view.options['aoColumns'] = [
                {sTitle: "uuid", mData: "uuid", bVisible: false},
                {sTitle: "Updated", mData: "updated", sWidth: '10%'},
                {sTitle: "Cluster", mData: "cluster_name", sWidth: '10%'},
                {sTitle: "Host", mData: "hostname", sWidth: '10%'},
                {sTitle: "am_cert_hash", mData: "am_cert_hash", bVisible: false},
                {sTitle: "Item Type", mData: "rowitem_type", sWidth: '10%'},
                {sTitle: "Tag", mData: "tagname", bVisible: false},
                {sTitle: "Summary", mData: "summary1", sWidth: '20%'},
                {sTitle: "Summary2", mData: "summary2", sWidth: '20%'},
                {sTitle: "MD5sum", mData: "md5sum", sWidth: '10%'},
                {sTitle: "Owner", mData: "username", sWidth: '10%'}
            ];

            view.options['aoColumnDefs'] = [
                {
                    mRender: function (data, type, row) {
                        return format_date(data);
                    },
                    aTargets: [1]
                }
            ];

            view.options['aaSorting'] = [];

            view.options['sDom'] = "Rlftip";

            if (!this.collection) {
                view.collection = new StrikeFinder.HitsCollection();
            }
            view.listenTo(view.collection, 'sync', view.render);
        },
        fetch: function (tagname) {
            var view = this;
            if (tagname) {
                view.collection.tagname = tagname;
            }
            StrikeFinder.block();
            view.collection.fetch({
                success: function() {
                    StrikeFinder.unblock();
                },
                error: function() {
                    StrikeFinder.unblock();
                }
            });
        }
    });

    StrikeFinder.HitsByTagView = StrikeFinder.View.extend({
        initialize: function () {
            var view = this;

            // Create a tag filter drop down.
            view.tags = new StrikeFinder.TagCollection();
            view.select_tag_view = new StrikeFinder.SelectView({
                el: "#tag-select",
                collection: view.tags,
                id_field: "name",
                value_field: "name",
                width: "200px"
            });
            view.listenTo(view.select_tag_view, 'change', function(value) {
                view.tagname = value;
                view.render();
            });
            view.tags.reset(StrikeFinder.searchable_tags);
        },
        render: function() {
            var view = this;
            log.debug('Rendering hits for tagname: ' + view.tagname);
            view.run_once('init_hits', function() {

                // Initialize the collapsables.
                StrikeFinder.collapse(view.$el);

                view.hits_table_view = new StrikeFinder.HitsByTagTableView({
                    el: '#hits-table'
                });
                view.listenTo(view.hits_table_view, 'load', function () {
                    view.hits_table_view.select_row(0);
                });

                // Create the hits details view.
                view.hits_details_view = new StrikeFinder.HitsDetailsView({
                    el: '#hits-details-div',
                    hits_table_view: view.hits_table_view,
                    suppress: false,
                    masstag: false
                });
                view.listenTo(view.hits_details_view, 'create:tag', function () {
                    view.hits_table_view.fetch();
                });
            });
            view.fetch();
        },
        fetch: function() {
            var view = this;
            $('#hits-div-title').html('<i class="icon-tag"></i> ' + view.tagname);
            view.hits_table_view.fetch(view.tagname);
        }
    });

    $(document).ready(function () {
        (function () {
            new StrikeFinder.HitsByTagView({
                el: document.body
            });
        })();
    });
</script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class='row-fluid' style="margin-bottom: 15px">
        <div class='span12'>
                    <span class="uac-header">
                        <i class="icon-filter"></i> Filter By Tag
                    </span>
            <select id="tag-select"></select>
        </div>
    </div>
    <div class='row-fluid'>
        <div class='span12'>
            <div id="hits-div" class="collapsable-header" collapsable-title="fsfsd">
                <table id="hits-table"
                       class="table table-striped table-bordered table-hover">
                </table>
            </div>
        </div>
    </div>

    {% set hide_hits = true %}
    {% set hide_suppressions = true %}
    {% include "sf/hits_template.html" %}

    <div class="row-fluid">
        <div class="span12">
            <br/>
        </div>
    </div>
</div>
{% endblock %}
